name: Main CI/CD Pipeline
# World-Class CI/CD for AI Bradaa
# Syeddy Orchestrator with 84-Mentor Framework

on:
  push:
    branches:
      - main
      - 'claude/**'
  pull_request:
    branches:
      - main

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  lint:
    name: ESLint Code Quality
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Install dependencies
        run: npm install

      - name: Run ESLint
        run: npm run lint
        continue-on-error: false

      - name: Comment lint results on PR
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âŒ **ESLint Failed**\n\nPlease fix linting errors before merging. Run `npm run lint` locally to see issues.'
            });

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: lint

    strategy:
      matrix:
        node-version: [18.x, 20.x]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}

      - name: Install dependencies
        run: npm install

      - name: Run tests
        run: npm test
        env:
          NODE_ENV: test

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-node-${{ matrix.node-version }}
          path: |
            coverage/
            test-results/
          retention-days: 30

  build:
    name: Build Application
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [lint, test]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Install dependencies
        run: npm install

      - name: Build application
        run: npm run build
        env:
          NODE_ENV: production

      - name: Verify build artifacts
        run: |
          if [ ! -d "dist" ]; then
            echo "âŒ Build failed: dist directory not found"
            exit 1
          fi

          echo "âœ… Build successful"
          ls -lah dist/

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: dist/
          retention-days: 7

  validate-data:
    name: Validate Data Integrity
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: lint

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Install dependencies
        run: npm install

      - name: Validate laptop database schema
        run: npm run test:data || echo "âš ï¸  Data validation tests not found, skipping..."

      - name: Check data file integrity
        run: |
          echo "ğŸ“Š Checking data files..."

          if [ ! -f "data/laptops.json" ]; then
            echo "âŒ data/laptops.json not found"
            exit 1
          fi

          # Validate JSON syntax
          if ! jq empty data/laptops.json 2>/dev/null; then
            echo "âŒ data/laptops.json is not valid JSON"
            exit 1
          fi

          # Count laptops
          LAPTOP_COUNT=$(jq '.laptops | length' data/laptops.json)
          echo "âœ… Laptop database valid: $LAPTOP_COUNT laptops"

          if [ "$LAPTOP_COUNT" -lt 50 ]; then
            echo "âš ï¸  Warning: Laptop count is low ($LAPTOP_COUNT)"
          fi

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: lint

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Install dependencies
        run: npm install

      - name: Run npm audit
        run: npm audit --audit-level=moderate
        continue-on-error: true

      - name: Check for secrets in code
        run: |
          echo "ğŸ” Scanning for potential secrets..."

          # Check for common secret patterns
          if grep -r "sk-" --include="*.js" --include="*.mjs" --exclude-dir=node_modules .; then
            echo "âš ï¸  Warning: Potential API key found (sk- pattern)"
          fi

          if grep -r "AKIA" --include="*.js" --include="*.mjs" --exclude-dir=node_modules .; then
            echo "âš ï¸  Warning: Potential AWS key found"
          fi

          echo "âœ… Secret scan completed"

  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [lint, test, build, validate-data, security-scan]
    if: always()

    steps:
      - name: Generate summary
        uses: actions/github-script@v7
        with:
          script: |
            const { data: jobs } = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.runId,
            });

            const results = jobs.jobs.map(job => ({
              name: job.name,
              status: job.conclusion || job.status,
            }));

            const passed = results.filter(r => r.status === 'success').length;
            const failed = results.filter(r => r.status === 'failure').length;
            const total = results.length;

            const emoji = failed === 0 ? 'âœ…' : 'âŒ';
            const status = failed === 0 ? 'PASSED' : 'FAILED';

            console.log(`${emoji} CI Pipeline ${status}: ${passed}/${total} jobs passed`);

            if (context.eventName === 'pull_request') {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `## ${emoji} CI Pipeline ${status}\n\n**Results:** ${passed}/${total} jobs passed\n\n${failed > 0 ? 'âŒ Please fix failing checks before merging.' : 'âœ… All checks passed!'}`
              });
            }
