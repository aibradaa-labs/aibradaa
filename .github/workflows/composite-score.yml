name: Composite Score Quality Gate
# 84-Mentor Approved: Syeddy Orchestrator - CI/CD Excellence

on:
  pull_request:
    branches: [main, master]
  push:
    branches: [main, master]

jobs:
  check-composite-score:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract composite score
        id: score
        run: |
          # Extract score from ULTIMATE_CONSOLIDATED_AUDIT_REPORT.md
          SCORE=$(grep -oP '\*\*Composite Score:\*\* \K[\d.]+' ULTIMATE_CONSOLIDATED_AUDIT_REPORT.md | head -1)

          if [ -z "$SCORE" ]; then
            echo "‚ùå Failed to extract composite score"
            exit 1
          fi

          echo "score=$SCORE" >> $GITHUB_OUTPUT
          echo "üìä Current Composite Score: $SCORE/100"

      - name: Check score threshold
        id: check
        run: |
          SCORE=${{ steps.score.outputs.score }}
          THRESHOLD=99

          # Compare using bc for float comparison
          if (( $(echo "$SCORE < $THRESHOLD" | bc -l) )); then
            echo "status=fail" >> $GITHUB_OUTPUT
            echo "‚ùå Score $SCORE is below threshold $THRESHOLD"
            exit 1
          else
            echo "status=pass" >> $GITHUB_OUTPUT
            echo "‚úÖ Score $SCORE meets threshold $THRESHOLD"
          fi

      - name: Update score history
        if: always()
        run: |
          SCORE=${{ steps.score.outputs.score }}
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          COMMIT_SHA=${{ github.sha }}
          BRANCH=${{ github.ref_name }}

          # Create ops directory if it doesn't exist
          mkdir -p ops

          # Initialize score-history.json if it doesn't exist
          if [ ! -f ops/score-history.json ]; then
            echo '{"scores": [], "metadata": {"created": "'$TIMESTAMP'", "repository": "'${{ github.repository }}'"}}' > ops/score-history.json
          fi

          # Append new score entry
          TEMP=$(mktemp)
          jq --arg score "$SCORE" \
             --arg timestamp "$TIMESTAMP" \
             --arg commit "$COMMIT_SHA" \
             --arg branch "$BRANCH" \
             '.scores += [{
               "score": ($score | tonumber),
               "timestamp": $timestamp,
               "commit": $commit,
               "branch": $branch,
               "event": "${{ github.event_name }}"
             }]' ops/score-history.json > "$TEMP"

          mv "$TEMP" ops/score-history.json

          # Calculate trend (last 5 scores)
          TREND=$(jq '.scores[-5:] | [.[].score] | (.[length-1] - .[0])' ops/score-history.json)

          echo "üìà Score Trend (last 5): $TREND"

          cat ops/score-history.json

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          script: |
            const score = ${{ steps.score.outputs.score }};
            const threshold = 99;
            const status = score >= threshold ? '‚úÖ PASS' : '‚ùå FAIL';
            const emoji = score >= threshold ? 'üéâ' : '‚ö†Ô∏è';

            // Calculate progress bar
            const barLength = 20;
            const filled = Math.round((score / 100) * barLength);
            const empty = barLength - filled;
            const progressBar = '‚ñà'.repeat(filled) + '‚ñë'.repeat(empty);

            // Determine grade
            let grade = 'F';
            if (score >= 99) grade = 'A+';
            else if (score >= 95) grade = 'A';
            else if (score >= 90) grade = 'B';
            else if (score >= 80) grade = 'C';
            else if (score >= 70) grade = 'D';

            const body = `## ${emoji} Composite Score Quality Gate ${status}

            ### Score: ${score}/100 (Grade: ${grade})

            \`\`\`
            ${progressBar} ${score}%
            \`\`\`

            **Threshold:** ‚â•${threshold}/100
            **Status:** ${status}

            ${score >= threshold
              ? '‚úÖ **Quality gate passed!** This PR meets production standards.'
              : `‚ùå **Quality gate failed!** Score must be ‚â•${threshold} to merge.\n\n**Action Required:** Review ULTIMATE_CONSOLIDATED_AUDIT_REPORT.md for improvement areas.`}

            ---

            **Recent Score History:**

            | Commit | Score | Change |
            |--------|-------|--------|
            | ${context.payload.pull_request.head.sha.substring(0, 7)} | ${score} | Current |

            <details>
            <summary>üìä View Scoring Criteria</summary>

            The composite score is calculated from:
            - **Test Coverage** (20 pts): ‚â•70% required
            - **Database Migration** (15 pts): PostgreSQL deployed
            - **SLO Monitoring** (15 pts): OTEL instrumentation
            - **Hallucination Detection** (15 pts): <8% threshold
            - **Cost Ceiling** (10 pts): Hard limits enforced
            - **Security** (10 pts): Encryption + auth
            - **Code Quality** (10 pts): No duplication
            - **Smol Compliance** (5 pts): ‚â•85% sections

            </details>
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Block merge if score too low
        if: steps.check.outputs.status == 'fail'
        run: |
          echo "::error title=Quality Gate Failed::Composite score ${{ steps.score.outputs.score }} is below threshold 99. Review ULTIMATE_CONSOLIDATED_AUDIT_REPORT.md for improvements."
          exit 1

      - name: Upload score history artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: score-history
          path: ops/score-history.json
          retention-days: 90
