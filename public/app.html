<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="AI Bradaa - Malaysia's AI-powered laptop advisor. Find the perfect laptop with personalized recommendations.">
  <meta name="theme-color" content="#D83F87">

  <!-- PWA Meta -->
  <link rel="manifest" href="/pwa/manifest.json">
  <link rel="apple-touch-icon" href="/assets/icons/icon-192x192.png">

  <!-- CSP -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://cdnjs.cloudflare.com https://accounts.google.com https://www.gstatic.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https: blob:; connect-src 'self' https://generativelanguage.googleapis.com https://accounts.google.com; frame-src 'self' https://accounts.google.com; object-src 'none'; base-uri 'self'; form-action 'self'; frame-ancestors 'none'; upgrade-insecure-requests; report-uri /api/csp-report">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Styles -->
  <link rel="stylesheet" href="/styles/app.css">

  <title>AI Bradaa - Malaysia's AI Laptop Advisor</title>
</head>
<body>
  <!-- App Shell -->
  <div id="app" class="app-container">

    <!-- Header/Navigation -->
    <header class="app-header">
      <div class="header-content">
        <div class="header-left">
          <button class="menu-toggle" id="menuToggle" aria-label="Toggle menu">
            <span class="hamburger"></span>
          </button>
          <div class="logo">
            <span class="logo-text">AI Bradaa</span>
            <span class="logo-badge">BETA</span>
          </div>
        </div>

        <nav class="header-nav" id="headerNav">
          <a href="#matchmaker" class="nav-item" data-section="matchmaker">
            <span class="nav-icon">ğŸ¯</span>
            <span class="nav-label">Matchmaker</span>
          </a>
          <a href="#versus" class="nav-item" data-section="versus">
            <span class="nav-icon">âš”ï¸</span>
            <span class="nav-label">Versus</span>
          </a>
          <a href="#explorer" class="nav-item" data-section="explorer">
            <span class="nav-icon">ğŸ”</span>
            <span class="nav-label">Explorer</span>
          </a>
          <a href="#command" class="nav-item active" data-section="command">
            <span class="nav-icon">ğŸ¤–</span>
            <span class="nav-label">Command</span>
          </a>
          <a href="#intel" class="nav-item nav-item-pro" data-section="intel">
            <span class="nav-icon">ğŸ“Š</span>
            <span class="nav-label">Intel</span>
            <span class="pro-badge">PRO</span>
          </a>
          <a href="#appendices" class="nav-item" data-section="appendices">
            <span class="nav-icon">ğŸ“š</span>
            <span class="nav-label">Appendices</span>
          </a>
        </nav>

        <div class="header-right">
          <button class="header-btn" id="searchBtn" aria-label="Search">
            <span>ğŸ”</span>
          </button>
          <button class="header-btn" id="notificationsBtn" aria-label="Notifications">
            <span>ğŸ””</span>
          </button>
          <div class="user-menu">
            <button class="user-avatar" id="userMenuBtn">
              <img src="/assets/default-avatar.png" alt="User" id="userAvatar">
            </button>
            <div class="user-dropdown" id="userDropdown">
              <div class="user-info">
                <div class="user-name" id="userName">Guest</div>
                <div class="user-tier" id="userTier">Free Tier</div>
              </div>
              <div class="dropdown-divider"></div>
              <a href="#settings" class="dropdown-item">âš™ï¸ Settings</a>
              <a href="#upgrade" class="dropdown-item">â­ Upgrade</a>
              <div class="dropdown-divider"></div>
              <button class="dropdown-item" id="logoutBtn">ğŸšª Logout</button>
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content Area -->
    <main class="app-main" id="appMain">

      <!-- Section: Matchmaker -->
      <section id="section-matchmaker" class="app-section" data-section="matchmaker">
        <div class="section-container">
          <iframe src="/matchmaker/index.html" class="section-iframe" frameborder="0"></iframe>
        </div>
      </section>

      <!-- Section: Versus -->
      <section id="section-versus" class="app-section" data-section="versus">
        <div class="section-container">
          <iframe src="/versus/index.html" class="section-iframe" frameborder="0"></iframe>
        </div>
      </section>

      <!-- Section: Explorer -->
      <section id="section-explorer" class="app-section" data-section="explorer">
        <div class="section-container">
          <iframe src="/explorer/index.html" class="section-iframe" frameborder="0"></iframe>
        </div>
      </section>

      <!-- Section: Command (Default) -->
      <section id="section-command" class="app-section active" data-section="command">
        <div class="section-container">
          <iframe src="/command/index.html" class="section-iframe" frameborder="0"></iframe>
        </div>
      </section>

      <!-- Section: Intel (Pro) -->
      <section id="section-intel" class="app-section" data-section="intel">
        <div class="section-container">
          <iframe src="/intel/index.html" class="section-iframe" frameborder="0"></iframe>
        </div>
      </section>

      <!-- Section: Appendices -->
      <section id="section-appendices" class="app-section" data-section="appendices">
        <div class="section-container">
          <iframe src="/appendices/index.html" class="section-iframe" frameborder="0"></iframe>
        </div>
      </section>

      <!-- Section: Camera Tech (Coming Soon) -->
      <section id="section-camera-tech" class="app-section" data-section="camera-tech">
        <div class="section-container">
          <div class="coming-soon">
            <div class="coming-soon-icon">ğŸ“¸</div>
            <h2>Camera Tech</h2>
            <p>Webcam specs and ratings coming in Phase 2</p>
            <p class="coming-soon-eta">Expected: Q2 2025</p>
          </div>
        </div>
      </section>

    </main>

    <!-- Footer -->
    <footer class="app-footer">
      <div class="footer-content">
        <div class="footer-left">
          <span class="footer-text">Â© 2025 AI Bradaa. All rights reserved.</span>
        </div>
        <div class="footer-center">
          <a href="/privacy.html" class="footer-link">Privacy</a>
          <a href="/terms.html" class="footer-link">Terms</a>
          <a href="/about.html" class="footer-link">About</a>
        </div>
        <div class="footer-right">
          <span class="footer-text">Made with â¤ï¸ in Malaysia</span>
        </div>
      </div>
    </footer>

  </div>

  <!-- Toast Container -->
  <div id="toastContainer" class="toast-container"></div>

  <!-- Modal Container -->
  <div id="modalContainer" class="modal-container"></div>

  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay">
    <div class="loading-spinner"></div>
    <div class="loading-text">Loading...</div>
  </div>

  <!-- Scripts -->
  <script type="module" src="/app/shared/utils/storage.mjs"></script>
  <script type="module" src="/app/shared/utils/api.mjs"></script>
  <script type="module">
    // App Shell Logic
    import { storage } from '/app/shared/utils/storage.mjs';
    import { apiClient } from '/app/shared/utils/api.mjs';

    // Initialize app
    async function initApp() {
      // Initialize storage
      await storage.init();

      // Check auth
      const token = storage.getToken();
      let user = null;

      if (token) {
        // Load user data if authenticated
        try {
          const response = await apiClient.get('/api/auth/me');
          user = response.data.user;

          // Update UI
          document.getElementById('userName').textContent = user.name || user.email;
          document.getElementById('userTier').textContent = `${user.tier.charAt(0).toUpperCase() + user.tier.slice(1)} Tier`;

          if (user.avatar) {
            document.getElementById('userAvatar').src = user.avatar;
          }
        } catch (error) {
          console.error('Failed to load user:', error);
        }
      } else {
        // Demo mode - show guest access
        document.getElementById('userName').textContent = 'Demo Mode';
        document.getElementById('userTier').textContent = 'Free Tier (Guest)';

        // Add signup prompt
        const userInfo = document.querySelector('.user-info');
        const signupPrompt = document.createElement('div');
        signupPrompt.className = 'signup-prompt';
        signupPrompt.innerHTML = '<a href="/signup.html" class="btn-signup-small">Sign Up to Save</a>';
        signupPrompt.style.marginTop = '8px';
        userInfo.appendChild(signupPrompt);
      }

      // Setup navigation
      setupNavigation();

      // Setup menu toggle
      setupMenuToggle();

      // Setup user menu
      setupUserMenu();

      // Hide loading overlay
      document.getElementById('loadingOverlay').classList.add('hidden');
    }

    // Navigation
    function setupNavigation() {
      const navItems = document.querySelectorAll('.nav-item');
      const sections = document.querySelectorAll('.app-section');

      navItems.forEach(item => {
        item.addEventListener('click', (e) => {
          e.preventDefault();

          const sectionId = item.dataset.section;

          // Update active nav item
          navItems.forEach(nav => nav.classList.remove('active'));
          item.classList.add('active');

          // Update active section
          sections.forEach(section => section.classList.remove('active'));
          document.getElementById(`section-${sectionId}`).classList.add('active');

          // Update URL hash
          window.location.hash = sectionId;
        });
      });

      // Handle initial hash
      const hash = window.location.hash.slice(1);
      if (hash) {
        const navItem = document.querySelector(`[data-section="${hash}"]`);
        if (navItem) {
          navItem.click();
        }
      }
    }

    // Menu toggle
    function setupMenuToggle() {
      const menuToggle = document.getElementById('menuToggle');
      const headerNav = document.getElementById('headerNav');

      menuToggle.addEventListener('click', () => {
        headerNav.classList.toggle('open');
        menuToggle.classList.toggle('open');
      });
    }

    // User menu
    function setupUserMenu() {
      const userMenuBtn = document.getElementById('userMenuBtn');
      const userDropdown = document.getElementById('userDropdown');
      const logoutBtn = document.getElementById('logoutBtn');

      userMenuBtn.addEventListener('click', () => {
        userDropdown.classList.toggle('open');
      });

      // Close on click outside
      document.addEventListener('click', (e) => {
        if (!userMenuBtn.contains(e.target) && !userDropdown.contains(e.target)) {
          userDropdown.classList.remove('open');
        }
      });

      // Logout
      logoutBtn.addEventListener('click', () => {
        storage.clearToken();
        window.location.href = '/signup.html';
      });
    }

    // Initialize on load
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initApp);
    } else {
      initApp();
    }

    // Register service worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/pwa/service-worker.js')
        .then(reg => console.log('Service Worker registered', reg))
        .catch(err => console.error('Service Worker registration failed', err));
    }
  </script>
</body>
</html>
